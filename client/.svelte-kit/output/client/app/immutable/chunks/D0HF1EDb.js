var d=Object.defineProperty;var u=(n,e,i)=>e in n?d(n,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[e]=i;var o=(n,e,i)=>u(n,typeof e!="symbol"?e+"":e,i);import{w as h}from"./B8tGgVml.js";const l="selectedMicrophoneId";function m(){const e={selectedMicrophoneId:(typeof window<"u"?localStorage.getItem(l):null)||null},{subscribe:i,set:a,update:s}=h(e);return{subscribe:i,setSelectedMicrophoneId:t=>{console.log("[DEBUG] Setting microphone ID:",t),s(r=>{const c={...r,selectedMicrophoneId:t};return typeof window<"u"&&(t?(localStorage.setItem(l,t),console.log("[DEBUG] Saved to localStorage:",t)):(localStorage.removeItem(l),console.log("[DEBUG] Removed from localStorage"))),c})},getSelectedMicrophoneId:()=>{let t=null;const r=i(c=>{t=c.selectedMicrophoneId,r()});return t},reset:()=>{a({selectedMicrophoneId:null}),typeof window<"u"&&localStorage.removeItem(l)}}}const f=m();class v{constructor(e={}){o(this,"_audioContext",null);o(this,"_mediaStream",null);o(this,"_analyser",null);o(this,"source",null);o(this,"mediaRecorder",null);o(this,"isRecording",!1);o(this,"onDataCallback",null);o(this,"onLevelCallback",null);o(this,"levelInterval",null);this.config=e}async initialize(){if(!this._audioContext)try{this._audioContext=new AudioContext({sampleRate:this.config.sampleRate||44100});const e={channelCount:this.config.channelCount||1,echoCancellation:this.config.echoCancellation??!0,noiseSuppression:this.config.noiseSuppression??!0,autoGainControl:this.config.autoGainControl??!0};this.config.deviceId?(e.deviceId={exact:this.config.deviceId},console.log("[AudioCapture] Initializing with specific device:",this.config.deviceId)):console.log("[AudioCapture] Initializing with default device"),this._mediaStream=await navigator.mediaDevices.getUserMedia({audio:e}),this._analyser=this._audioContext.createAnalyser(),this._analyser.fftSize=256,this._analyser.smoothingTimeConstant=.8,this.source=this._audioContext.createMediaStreamSource(this._mediaStream),this.source.connect(this._analyser)}catch(e){if(this.config.deviceId&&e instanceof Error){console.warn("[AudioCapture] Failed to initialize with specific device, trying default:",e.message),this.cleanup();try{this._audioContext=new AudioContext({sampleRate:this.config.sampleRate||44100}),this._mediaStream=await navigator.mediaDevices.getUserMedia({audio:{channelCount:this.config.channelCount||1,echoCancellation:this.config.echoCancellation??!0,noiseSuppression:this.config.noiseSuppression??!0,autoGainControl:this.config.autoGainControl??!0}}),this._analyser=this._audioContext.createAnalyser(),this._analyser.fftSize=256,this._analyser.smoothingTimeConstant=.8,this.source=this._audioContext.createMediaStreamSource(this._mediaStream),this.source.connect(this._analyser),console.warn("[AudioCapture] Successfully initialized with default device");return}catch(i){throw this.cleanup(),new Error(`Failed to initialize audio with device ${this.config.deviceId}: ${e}. Also failed with default device: ${i}`)}}throw this.cleanup(),new Error(`Failed to initialize audio: ${e}`)}}async startRecording(e){if(!this._mediaStream||!this._audioContext)throw new Error("Audio not initialized. Call initialize() first.");if(this.isRecording)return;this.onDataCallback=e;const i=this.getSupportedMimeType();this.mediaRecorder=new MediaRecorder(this._mediaStream,{mimeType:i}),this.mediaRecorder.ondataavailable=a=>{a.data.size>0&&this.onDataCallback&&this.onDataCallback(a.data)},this.mediaRecorder.start(100),this.isRecording=!0}stopRecording(){!this.isRecording||!this.mediaRecorder||(this.mediaRecorder.stop(),this.isRecording=!1)}startLevelMonitoring(e,i=100){if(!this._analyser)throw new Error("Audio not initialized. Call initialize() first.");this.onLevelCallback=e,this.levelInterval=setInterval(()=>{const a=this.getCurrentLevel();this.onLevelCallback&&this.onLevelCallback(a)},i)}stopLevelMonitoring(){this.levelInterval&&(clearInterval(this.levelInterval),this.levelInterval=null)}getCurrentLevel(){if(!this._analyser)return{level:0,timestamp:Date.now()};const e=new Uint8Array(this._analyser.frequencyBinCount);return this._analyser.getByteFrequencyData(e),{level:e.reduce((s,t)=>s+t,0)/e.length/255,timestamp:Date.now()}}getSupportedMimeType(){const e=["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/ogg"];for(const i of e)if(MediaRecorder.isTypeSupported(i))return i;return""}cleanup(){this.stopRecording(),this.stopLevelMonitoring(),this._mediaStream&&(this._mediaStream.getTracks().forEach(e=>e.stop()),this._mediaStream=null),this.source&&(this.source.disconnect(),this.source=null),this._audioContext&&this._audioContext.state!=="closed"&&(this._audioContext.close(),this._audioContext=null),this._analyser=null,this.mediaRecorder=null,this.onDataCallback=null,this.onLevelCallback=null}isInitialized(){return this._audioContext!==null&&this._mediaStream!==null}isRecordingActive(){return this.isRecording}get mediaStream(){return this._mediaStream}get audioContext(){return this._audioContext}get analyser(){return this._analyser}async getDevices(){let e=await navigator.mediaDevices.enumerateDevices();const i=e.filter(t=>t.kind==="audioinput");if(!i.some(t=>t.label&&t.label.trim()!=="")&&i.length>0){console.log("[AudioCapture] Labels empty, requesting microphone permission...");try{(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(r=>r.stop()),e=await navigator.mediaDevices.enumerateDevices(),console.log("[AudioCapture] Permission granted, devices refreshed")}catch(t){throw console.error("[AudioCapture] Failed to request microphone permission:",t),new Error(`Failed to request microphone permission: ${t}`)}}const s=e.filter(t=>t.kind==="audioinput");return console.log("[AudioCapture] Found audio devices:",s.map(t=>({deviceId:t.deviceId,label:t.label||"(empty)",groupId:t.groupId}))),s}}export{v as A,f as s};
