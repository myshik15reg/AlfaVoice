import{c as f,v,a as q,b as y,e as _,f as g,m as p}from"../../../chunks/ssr.js";import{H as S}from"../../../chunks/Header.js";import{s as m,M as x,G as $}from"../../../chunks/settingsStore.js";import{I}from"../../../chunks/file-text.js";const k=f((i,e,s,r)=>{const a=[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z"}],["path",{d:"M16 9a5 5 0 0 1 0 6"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728"}]];return`${v(I,"Icon").$$render(i,Object.assign({},{name:"volume-2"},e,{iconNode:a}),{},{default:()=>`${r.default?r.default({}):""}`})}`});class C{constructor(e={}){this.config=e}_audioContext=null;_mediaStream=null;_analyser=null;source=null;mediaRecorder=null;isRecording=!1;onDataCallback=null;onLevelCallback=null;levelInterval=null;async initialize(){if(!this._audioContext)try{this._audioContext=new AudioContext({sampleRate:this.config.sampleRate||44100});const e={channelCount:this.config.channelCount||1,echoCancellation:this.config.echoCancellation??!0,noiseSuppression:this.config.noiseSuppression??!0,autoGainControl:this.config.autoGainControl??!0};this.config.deviceId?(e.deviceId={exact:this.config.deviceId},console.log("[AudioCapture] Initializing with specific device:",this.config.deviceId)):console.log("[AudioCapture] Initializing with default device"),this._mediaStream=await navigator.mediaDevices.getUserMedia({audio:e}),this._analyser=this._audioContext.createAnalyser(),this._analyser.fftSize=256,this._analyser.smoothingTimeConstant=.8,this.source=this._audioContext.createMediaStreamSource(this._mediaStream),this.source.connect(this._analyser)}catch(e){if(this.config.deviceId&&e instanceof Error){console.warn("[AudioCapture] Failed to initialize with specific device, trying default:",e.message),this.cleanup();try{this._audioContext=new AudioContext({sampleRate:this.config.sampleRate||44100}),this._mediaStream=await navigator.mediaDevices.getUserMedia({audio:{channelCount:this.config.channelCount||1,echoCancellation:this.config.echoCancellation??!0,noiseSuppression:this.config.noiseSuppression??!0,autoGainControl:this.config.autoGainControl??!0}}),this._analyser=this._audioContext.createAnalyser(),this._analyser.fftSize=256,this._analyser.smoothingTimeConstant=.8,this.source=this._audioContext.createMediaStreamSource(this._mediaStream),this.source.connect(this._analyser),console.warn("[AudioCapture] Successfully initialized with default device");return}catch(s){throw this.cleanup(),new Error(`Failed to initialize audio with device ${this.config.deviceId}: ${e}. Also failed with default device: ${s}`)}}throw this.cleanup(),new Error(`Failed to initialize audio: ${e}`)}}async startRecording(e){if(!this._mediaStream||!this._audioContext)throw new Error("Audio not initialized. Call initialize() first.");if(this.isRecording)return;this.onDataCallback=e;const s=this.getSupportedMimeType();this.mediaRecorder=new MediaRecorder(this._mediaStream,{mimeType:s}),this.mediaRecorder.ondataavailable=r=>{r.data.size>0&&this.onDataCallback&&this.onDataCallback(r.data)},this.mediaRecorder.start(100),this.isRecording=!0}stopRecording(){!this.isRecording||!this.mediaRecorder||(this.mediaRecorder.stop(),this.isRecording=!1)}startLevelMonitoring(e,s=100){if(!this._analyser)throw new Error("Audio not initialized. Call initialize() first.");this.onLevelCallback=e,this.levelInterval=setInterval(()=>{const r=this.getCurrentLevel();this.onLevelCallback&&this.onLevelCallback(r)},s)}stopLevelMonitoring(){this.levelInterval&&(clearInterval(this.levelInterval),this.levelInterval=null)}getCurrentLevel(){if(!this._analyser)return{level:0,timestamp:Date.now()};const e=new Uint8Array(this._analyser.frequencyBinCount);return this._analyser.getByteFrequencyData(e),{level:e.reduce((a,t)=>a+t,0)/e.length/255,timestamp:Date.now()}}getSupportedMimeType(){const e=["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/ogg"];for(const s of e)if(MediaRecorder.isTypeSupported(s))return s;return""}cleanup(){this.stopRecording(),this.stopLevelMonitoring(),this._mediaStream&&(this._mediaStream.getTracks().forEach(e=>e.stop()),this._mediaStream=null),this.source&&(this.source.disconnect(),this.source=null),this._audioContext&&this._audioContext.state!=="closed"&&(this._audioContext.close(),this._audioContext=null),this._analyser=null,this.mediaRecorder=null,this.onDataCallback=null,this.onLevelCallback=null}isInitialized(){return this._audioContext!==null&&this._mediaStream!==null}isRecordingActive(){return this.isRecording}get mediaStream(){return this._mediaStream}get audioContext(){return this._audioContext}get analyser(){return this._analyser}async getDevices(){let e=await navigator.mediaDevices.enumerateDevices();const s=e.filter(t=>t.kind==="audioinput");if(!s.some(t=>t.label&&t.label.trim()!=="")&&s.length>0){console.log("[AudioCapture] Labels empty, requesting microphone permission...");try{(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(c=>c.stop()),e=await navigator.mediaDevices.enumerateDevices(),console.log("[AudioCapture] Permission granted, devices refreshed")}catch(t){throw console.error("[AudioCapture] Failed to request microphone permission:",t),new Error(`Failed to request microphone permission: ${t}`)}}const a=e.filter(t=>t.kind==="audioinput");return console.log("[AudioCapture] Found audio devices:",a.map(t=>({deviceId:t.deviceId,label:t.label||"(empty)",groupId:t.groupId}))),a}}const z={code:".dialog-overlay.svelte-tsja7e.svelte-tsja7e{position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0, 0, 0, 0.5);display:flex;align-items:center;justify-content:center;z-index:1000}.dialog.svelte-tsja7e.svelte-tsja7e{background-color:white;border-radius:8px;box-shadow:0 4px 20px rgba(0, 0, 0, 0.2);width:90%;max-width:500px;max-height:80vh;display:flex;flex-direction:column}.dialog-header.svelte-tsja7e.svelte-tsja7e{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid #e5e7eb}.dialog-header.svelte-tsja7e h2.svelte-tsja7e{margin:0;font-size:1.25rem;font-weight:600;color:#111827}.close-button.svelte-tsja7e.svelte-tsja7e{background:none;border:none;font-size:1.5rem;cursor:pointer;padding:4px 8px;color:#6b7280;transition:color 0.2s}.close-button.svelte-tsja7e.svelte-tsja7e:hover{color:#111827}.dialog-content.svelte-tsja7e.svelte-tsja7e{padding:20px;overflow-y:auto}.loading.svelte-tsja7e.svelte-tsja7e,.error.svelte-tsja7e.svelte-tsja7e,.empty.svelte-tsja7e.svelte-tsja7e{text-align:center;padding:20px;color:#6b7280}.error.svelte-tsja7e.svelte-tsja7e{color:#dc2626}.device-list.svelte-tsja7e.svelte-tsja7e{list-style:none;padding:0;margin:0}.device-item.svelte-tsja7e.svelte-tsja7e{padding:12px 16px;border:1px solid #e5e7eb;border-radius:6px;margin-bottom:8px;cursor:pointer;transition:all 0.2s}.device-item.svelte-tsja7e.svelte-tsja7e:hover{background-color:#f9fafb;border-color:#d1d5db}.device-item.selected.svelte-tsja7e.svelte-tsja7e{background-color:#eff6ff;border-color:#3b82f6}.device-item.svelte-tsja7e.svelte-tsja7e:focus{outline:2px solid #3b82f6;outline-offset:2px}.device-info.svelte-tsja7e.svelte-tsja7e{display:flex;justify-content:space-between;align-items:center}.device-label.svelte-tsja7e.svelte-tsja7e{font-size:0.95rem;color:#111827}.selected-indicator.svelte-tsja7e.svelte-tsja7e{color:#3b82f6;font-weight:bold;font-size:1.1rem}",map:null},M=f((i,e,s,r)=>{let a,t;q(m,"settingsStore"),t=y(m,l=>a=l);let{open:c=!1}=e,n=[],d=!1,u=null;async function h(){d=!0,u=null,n=[];try{n=(await new C().getDevices()).map(o=>({deviceId:o.deviceId,label:o.label||`Microphone ${o.deviceId.slice(0,8)}...`,kind:o.kind}))}catch(l){u=l instanceof Error?l.message:"Failed to load microphones"}finally{d=!1}}return e.open===void 0&&s.open&&c!==void 0&&s.open(c),i.css.add(z),c&&n.length===0&&h(),t(),`${c?`<div class="dialog-overlay svelte-tsja7e"><div class="dialog svelte-tsja7e"><div class="dialog-header svelte-tsja7e"><h2 class="svelte-tsja7e" data-svelte-h="svelte-vlqfe6">Select Microphone</h2> <button class="close-button svelte-tsja7e" aria-label="Close" data-svelte-h="svelte-apaby2">✕</button></div> <div class="dialog-content svelte-tsja7e">${d?'<div class="loading svelte-tsja7e" data-svelte-h="svelte-p2j21a">Loading microphones...</div>':`${u?`<div class="error svelte-tsja7e">${g(u)}</div>`:`${n.length===0?'<div class="empty svelte-tsja7e" data-svelte-h="svelte-10c5d20">No microphones found</div>':`<ul class="device-list svelte-tsja7e">${_(n,l=>`<li class="${["device-item svelte-tsja7e",a.selectedMicrophoneId===l.deviceId?"selected":""].join(" ").trim()}" role="button" tabindex="0"><div class="device-info svelte-tsja7e"><span class="device-label svelte-tsja7e">${g(l.label)}</span> ${a.selectedMicrophoneId===l.deviceId?'<span class="selected-indicator svelte-tsja7e" data-svelte-h="svelte-6ki677">✓</span>':""}</div> </li>`)}</ul>`}`}`}</div></div></div>`:""}`}),D={code:".page-container.svelte-1q7urtj.svelte-1q7urtj{padding:2rem;max-width:1000px;margin:0 auto}.content.svelte-1q7urtj.svelte-1q7urtj{margin-top:2rem}.settings-container.svelte-1q7urtj.svelte-1q7urtj{display:flex;flex-direction:column;gap:2rem}.page-title.svelte-1q7urtj.svelte-1q7urtj{font-size:2rem;font-weight:600;margin:0;color:var(--text-primary)}.settings-section.svelte-1q7urtj.svelte-1q7urtj{background-color:white;border-radius:12px;box-shadow:0 1px 3px rgba(0, 0, 0, 0.1);padding:1.5rem}.section-header.svelte-1q7urtj.svelte-1q7urtj{margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid #e5e7eb}.section-title.svelte-1q7urtj.svelte-1q7urtj{display:flex;align-items:center;gap:0.75rem}.section-title.svelte-1q7urtj h2.svelte-1q7urtj{font-size:1.25rem;font-weight:600;margin:0;color:var(--text-primary)}.setting-item.svelte-1q7urtj.svelte-1q7urtj{display:flex;justify-content:space-between;align-items:flex-start;gap:2rem;padding:1rem 0}.setting-info.svelte-1q7urtj.svelte-1q7urtj{flex:1}.setting-label.svelte-1q7urtj.svelte-1q7urtj{display:block;font-size:1rem;font-weight:500;color:var(--text-primary);margin-bottom:0.25rem}.setting-description.svelte-1q7urtj.svelte-1q7urtj{font-size:0.875rem;color:var(--text-muted);margin:0}.setting-control.svelte-1q7urtj.svelte-1q7urtj{display:flex;align-items:center;gap:1rem;flex-shrink:0}.microphone-label.svelte-1q7urtj.svelte-1q7urtj{display:flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;background-color:#f3f4f6;border-radius:6px;font-size:0.875rem;color:var(--text-primary);min-width:200px}.microphone-label.loading.svelte-1q7urtj.svelte-1q7urtj{color:var(--text-muted)}.change-button.svelte-1q7urtj.svelte-1q7urtj{padding:0.5rem 1rem;background-color:var(--primary-color);color:white;border:none;border-radius:6px;font-size:0.875rem;font-weight:500;cursor:pointer;transition:background-color 0.2s}.change-button.svelte-1q7urtj.svelte-1q7urtj:hover{background-color:#2563eb}.change-button.svelte-1q7urtj.svelte-1q7urtj:active{background-color:#1d4ed8}.coming-soon.svelte-1q7urtj.svelte-1q7urtj{font-size:0.875rem;color:var(--text-muted);font-style:italic;margin:0}@media(max-width: 640px){.setting-item.svelte-1q7urtj.svelte-1q7urtj{flex-direction:column;gap:1rem}.setting-control.svelte-1q7urtj.svelte-1q7urtj{width:100%;justify-content:space-between}.microphone-label.svelte-1q7urtj.svelte-1q7urtj{flex:1}}",map:null},G=f((i,e,s,r)=>{let a,t;q(m,"settingsStore"),t=y(m,o=>a=o);let c=!1,n="Default",d=!1;async function u(){d=!0;try{const o=a.selectedMicrophoneId;if(!o){n="Default";return}const b=(await new C().getDevices()).find(w=>w.deviceId===o);b?.label?n=b.label:n=`Microphone ${o.slice(0,8)}...`}catch(o){console.error("Failed to get microphone label:",o),n="Default"}finally{d=!1}}i.css.add(D);let h,l,j=i.head;do h=!0,i.head=j,a.selectedMicrophoneId&&u(),l=`<div class="page-container svelte-1q7urtj">${v(S,"Header").$$render(i,{},{},{})} <div class="content svelte-1q7urtj"><div class="settings-container svelte-1q7urtj"><h1 class="page-title svelte-1q7urtj" data-svelte-h="svelte-1hus8pa">Настройки</h1>  <section class="settings-section svelte-1q7urtj"><div class="section-header svelte-1q7urtj"><div class="section-title svelte-1q7urtj">${v(x||p,"svelte:component").$$render(i,{size:20,class:"section-icon"},{},{})} <h2 class="svelte-1q7urtj" data-svelte-h="svelte-pxwg5v">Микрофон</h2></div></div> <div class="setting-item svelte-1q7urtj"><div class="setting-info svelte-1q7urtj"><label class="setting-label svelte-1q7urtj" data-svelte-h="svelte-1ypr2e3">Выбранный микрофон</label> <p class="setting-description svelte-1q7urtj" data-svelte-h="svelte-1aar4yd">Выберите устройство для записи голоса</p></div> <div class="setting-control svelte-1q7urtj">${d?'<div class="microphone-label loading svelte-1q7urtj" data-svelte-h="svelte-r1ps2s">Загрузка...</div>':`<div class="microphone-label svelte-1q7urtj">${v(x||p,"svelte:component").$$render(i,{size:16,class:"mic-icon"},{},{})} <span>${g(n)}</span></div>`} <button class="change-button svelte-1q7urtj" data-svelte-h="svelte-1q0ngq9">Изменить</button></div></div></section>  <section class="settings-section svelte-1q7urtj"><div class="section-header svelte-1q7urtj"><div class="section-title svelte-1q7urtj">${v(k||p,"svelte:component").$$render(i,{size:20,class:"section-icon"},{},{})} <h2 class="svelte-1q7urtj" data-svelte-h="svelte-6rmuc5">Аудио</h2></div></div> <div class="setting-item svelte-1q7urtj"><p class="coming-soon svelte-1q7urtj" data-svelte-h="svelte-1togwdk">Скоро будет доступно</p></div></section> <section class="settings-section svelte-1q7urtj"><div class="section-header svelte-1q7urtj"><div class="section-title svelte-1q7urtj">${v($||p,"svelte:component").$$render(i,{size:20,class:"section-icon"},{},{})} <h2 class="svelte-1q7urtj" data-svelte-h="svelte-n2j24x">Язык</h2></div></div> <div class="setting-item svelte-1q7urtj"><p class="coming-soon svelte-1q7urtj" data-svelte-h="svelte-1togwdk">Скоро будет доступно</p></div></section></div></div></div>  ${v(M,"MicrophoneDialog").$$render(i,{open:c},{open:o=>{c=o,h=!1}},{})}`;while(!h);return t(),l});export{G as default};
