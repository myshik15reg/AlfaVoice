# КД 3.0 - Конвертация Данных 3.0

## Обзор

Конвертация Данных 3.0 (КД 3.0) — стандарт для разработки правил обмена данными между конфигурациями 1С:Предприятие. Используется для синхронизации справочников, документов и регистров между различными информационными базами.

## Архитектура КД 3.0

### Основные компоненты

```
┌─────────────────────────────────────────────────────────────┐
│                    ПКД (Правила конвертации)                │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐                   │
│  │ Правила выгрузки │  │ Правила загрузки │                   │
│  └────────┬────────┘  └────────┬────────┘                   │
│           │                    │                            │
│  ┌────────▼────────┐  ┌────────▼────────┐                   │
│  │  Маппинг полей  │  │  Маппинг полей  │                   │
│  └────────┬────────┘  └────────┬────────┘                   │
│           │                    │                            │
│  ┌────────▼────────┐  ┌────────▼────────┐                   │
│  │   Алгоритмы     │  │   Алгоритмы     │                   │
│  └────────┬────────┘  └────────┬────────┘                   │
│           │                    │                            │
│  ┌────────▼────────┐  ┌────────▼────────┐                   │
│  │    Запросы      │  │    Обработчики  │                   │
│  └─────────────────┘  └─────────────────┘                   │
└─────────────────────────────────────────────────────────────┘
```

### Структура ПКД

| Компонент | Описание |
|-----------|----------|
| **ПКД** | Набор правил конвертации (корневой элемент) |
| **Правила выгрузки** | Правила преобразования данных источника |
| **Правила загрузки** | Правила преобразования данных приёмника |
| **Маппинг** | Соответствие реквизитов источника и приёмника |
| **Алгоритмы** | Обработчики событий конвертации |
| **Запросы** | SQL-запросы для выборки данных |

## Именование

### Правила конвертации

Формат: `ПКД_<Источник>_<Приёмник>_<Объект>`

```
ПКД_CRM_ERP_Контрагенты
ПКД_CRM_ERP_Договоры
ПКД_ERP_DWH_Транзакции
```

### Правила выгрузки/загрузки

Формат: `ПВД_<Объект>` / `ПЗД_<Объект>`

```
ПВД_Контрагенты       # Правило выгрузки данных
ПЗД_Контрагенты       # Правило загрузки данных
ПВД_ДоговорыЛизинга
ПЗД_ДоговорыЛизинга
```

### Алгоритмы

Формат: `<Событие>_<Объект>_<Действие>`

```
ПередВыгрузкой_Контрагент_Валидация
ПослеВыгрузки_Контрагент_Логирование
ПередЗагрузкой_Договор_ПроверкаДублей
ПослеЗагрузки_Договор_РасчётГрафика
ПриОбработкеПоиска_Номенклатура_ПоискПоАртикулу
```

## Workflow разработки

### Полный цикл

```
1. Анализ
   ├── Изучение структуры источника
   ├── Изучение структуры приёмника
   └── Определение правил маппинга

2. Проектирование
   ├── Создание ПКД в конфигураторе КД 3.0
   ├── Определение правил выгрузки
   ├── Определение правил загрузки
   └── Проектирование алгоритмов

3. Разработка
   ├── Настройка маппинга полей
   ├── Разработка алгоритмов обработки
   ├── Разработка запросов выборки
   └── Обработка особых случаев

4. Тестирование
   ├── Тестирование на тестовых базах
   ├── Проверка корректности данных
   ├── Тестирование обработки ошибок
   └── Нагрузочное тестирование

5. Code Review
   ├── Проверка соответствия стандартам
   ├── Оптимизация алгоритмов
   └── Документирование

6. Релиз
   ├── Развёртывание в production
   ├── Мониторинг первых обменов
   └── Документирование для поддержки
```

## Обработчики событий

### Последовательность вызова (выгрузка)

```
1. ПередНачаломВыгрузки    → Инициализация
2. ПередВыгрузкойОбъекта   → Валидация объекта
3. ПередВыгрузкойСвойства  → Преобразование реквизита
4. ПослеВыгрузкиСвойства   → Постобработка реквизита
5. ПослеВыгрузкиОбъекта    → Финализация объекта
6. ПослеОкончанияВыгрузки  → Завершение обмена
```

### Последовательность вызова (загрузка)

```
1. ПередНачаломЗагрузки    → Инициализация
2. ПередЗагрузкойОбъекта   → Поиск существующего
3. ПриОбработкеПоиска      → Кастомный поиск
4. ПередЗагрузкойСвойства  → Валидация значения
5. ПослеЗагрузкиСвойства   → Постобработка
6. ПослеЗагрузкиОбъекта    → Дополнительные действия
7. ПослеОкончанияЗагрузки  → Завершение
```

## Примеры алгоритмов

### ПередВыгрузкой — Валидация

```bsl
// Алгоритм: ПередВыгрузкой_Контрагент_Валидация
// Описание: Проверяет корректность данных перед выгрузкой

Если НЕ ЗначениеЗаполнено(Объект.ИНН) Тогда
    // Пропускаем контрагентов без ИНН
    Отказ = Истина;
    Возврат;
КонецЕсли;

Если Объект.ПометкаУдаления Тогда
    // Помеченные на удаление не выгружаем
    Отказ = Истина;
    Возврат;
КонецЕсли;

// Проверяем актуальность данных
Если Объект.ДатаИзменения < ДатаПоследнегоОбмена Тогда
    Отказ = Истина;
    Возврат;
КонецЕсли;
```

### ПриОбработкеПоиска — Кастомный поиск

```bsl
// Алгоритм: ПриОбработкеПоиска_Контрагент_ПоИНН
// Описание: Поиск контрагента по ИНН вместо GUID

Если ЗначениеЗаполнено(ДанныеXDTO.ИНН) Тогда

    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ ПЕРВЫЕ 1
        |   Контрагенты.Ссылка КАК Ссылка
        |ИЗ
        |   Справочник.Контрагенты КАК Контрагенты
        |ГДЕ
        |   Контрагенты.ИНН = &ИНН
        |   И НЕ Контрагенты.ПометкаУдаления";

    Запрос.УстановитьПараметр("ИНН", ДанныеXDTO.ИНН);

    Результат = Запрос.Выполнить();
    Если НЕ Результат.Пустой() Тогда
        Выборка = Результат.Выбрать();
        Выборка.Следующий();
        НайденныйОбъект = Выборка.Ссылка;
    КонецЕсли;

КонецЕсли;
```

### ПослеЗагрузки — Дополнительные действия

```bsl
// Алгоритм: ПослеЗагрузки_Договор_РасчётГрафика
// Описание: Автоматический расчёт графика после загрузки договора

Если ЗначениеЗаполнено(Объект.Ссылка) Тогда

    // Проверяем необходимость пересчёта
    Если Объект.СуммаДоговора <> СтароеЗначение.СуммаДоговора
        ИЛИ Объект.СрокДоговора <> СтароеЗначение.СрокДоговора Тогда

        Попытка
            // Вызываем пересчёт графика
            ал_РасчётГрафика.ПересчитатьГрафик(Объект.Ссылка);

            // Логируем успех
            ал_Логирование.ЗаписатьИнформацию(
                "КД3.0",
                "График пересчитан для договора: " + Объект.Номер
            );
        Исключение
            ал_Логирование.ЗаписатьОшибку(
                "КД3.0",
                "Ошибка пересчёта графика: " + ОписаниеОшибки()
            );
        КонецПопытки;

    КонецЕсли;

КонецЕсли;
```

### Обработка табличных частей

```bsl
// Алгоритм: ПередВыгрузкой_ТЧ_Товары
// Описание: Фильтрация строк табличной части

НовыеСтроки = Новый Массив;

Для Каждого СтрокаТЧ Из Объект.Товары Цикл

    // Пропускаем нулевые строки
    Если СтрокаТЧ.Количество = 0 Тогда
        Продолжить;
    КонецЕсли;

    // Пропускаем услуги (только товары)
    Если СтрокаТЧ.Номенклатура.ЭтоУслуга Тогда
        Продолжить;
    КонецЕсли;

    НовыеСтроки.Добавить(СтрокаТЧ);

КонецЦикла;

Объект.Товары = НовыеСтроки;
```

## Маппинг полей

### Простой маппинг

```xml
<ПравилоКонвертации>
  <Источник>Справочник.Контрагенты</Источник>
  <Приёмник>Справочник.Контрагенты</Приёмник>

  <СоответствиеРеквизитов>
    <Реквизит Источник="Наименование" Приёмник="Наименование"/>
    <Реквизит Источник="ИНН" Приёмник="ИНН"/>
    <Реквизит Источник="КПП" Приёмник="КПП"/>
    <Реквизит Источник="Телефон" Приёмник="ОсновнойТелефон"/>
  </СоответствиеРеквизитов>
</ПравилоКонвертации>
```

### Маппинг с преобразованием

```bsl
// Маппинг: Статус контрагента
// Источник: Перечисление.СтатусыКонтрагентов (CRM)
// Приёмник: Перечисление.СостоянияКонтрагентов (ERP)

Функция ПреобразоватьСтатус(СтатусИсточник)

    Соответствие = Новый Соответствие;
    Соответствие.Вставить("Активный", "Работаем");
    Соответствие.Вставить("Потенциальный", "Лид");
    Соответствие.Вставить("Архивный", "Закрыт");
    Соответствие.Вставить("Заблокирован", "Заблокирован");

    СтатусПриёмник = Соответствие.Получить(Строка(СтатусИсточник));

    Если СтатусПриёмник = Неопределено Тогда
        // Значение по умолчанию
        СтатусПриёмник = "Лид";
    КонецЕсли;

    Возврат Перечисления.СостоянияКонтрагентов[СтатусПриёмник];

КонецФункции
```

## Обработка ошибок

### Паттерн безопасной обработки

```bsl
// Алгоритм: ОбработкаОшибки_Загрузка
// Описание: Централизованная обработка ошибок загрузки

Процедура ОбработатьОшибкуЗагрузки(ОписаниеОшибки, ДанныеОбъекта)

    // Логирование
    ал_Логирование.ЗаписатьОшибку("КД3.0",
        СтрШаблон("Ошибка загрузки объекта %1: %2",
            ДанныеОбъекта.Тип,
            ОписаниеОшибки));

    // Сохранение в очередь повторной обработки
    Запись = РегистрыСведений.ОчередьОшибокОбмена.СоздатьМенеджерЗаписи();
    Запись.ДатаОшибки = ТекущаяДатаСеанса();
    Запись.ТипОбъекта = ДанныеОбъекта.Тип;
    Запись.ИдентификаторОбъекта = ДанныеОбъекта.GUID;
    Запись.ОписаниеОшибки = ОписаниеОшибки;
    Запись.ДанныеXML = ДанныеОбъекта.XMLПредставление;
    Запись.Статус = Перечисления.СтатусыОшибок.НоваяОшибка;
    Запись.Записать();

    // Уведомление (для критичных ошибок)
    Если СодержитКритичнуюОшибку(ОписаниеОшибки) Тогда
        ал_Уведомления.ОтправитьАдминистратору(
            "Критичная ошибка КД 3.0",
            ОписаниеОшибки);
    КонецЕсли;

КонецПроцедуры
```

### Retry логика

```bsl
// Алгоритм: ПовторнаяОбработка
// Описание: Механизм повторной обработки ошибочных объектов

Процедура ОбработатьОчередьОшибок() Экспорт

    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ ПЕРВЫЕ 100
        |   Очередь.ДатаОшибки,
        |   Очередь.ТипОбъекта,
        |   Очередь.ИдентификаторОбъекта,
        |   Очередь.ДанныеXML,
        |   Очередь.КоличествоПопыток
        |ИЗ
        |   РегистрСведений.ОчередьОшибокОбмена КАК Очередь
        |ГДЕ
        |   Очередь.Статус = &СтатусНовая
        |   И Очередь.КоличествоПопыток < 3
        |УПОРЯДОЧИТЬ ПО
        |   Очередь.ДатаОшибки";

    Запрос.УстановитьПараметр("СтатусНовая",
        Перечисления.СтатусыОшибок.НоваяОшибка);

    Выборка = Запрос.Выполнить().Выбрать();

    Пока Выборка.Следующий() Цикл

        Попытка
            // Повторная загрузка
            ЗагрузитьОбъектИзXML(Выборка.ДанныеXML);

            // Успех — удаляем из очереди
            УдалитьИзОчереди(Выборка.ИдентификаторОбъекта);

        Исключение
            // Увеличиваем счётчик попыток
            УвеличитьСчётчикПопыток(Выборка.ИдентификаторОбъекта);
        КонецПопытки;

    КонецЦикла;

КонецПроцедуры
```

## Оптимизация производительности

### Пакетная обработка

```bsl
// Выгрузка пакетами по 1000 объектов
ПакетВыгрузки = 1000;
Смещение = 0;

Пока Истина Цикл

    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ ПЕРВЫЕ 1000
        |   Контрагенты.Ссылка
        |ИЗ
        |   Справочник.Контрагенты КАК Контрагенты
        |ГДЕ
        |   Контрагенты.ДатаИзменения > &ДатаПоследнегоОбмена
        |   И НЕ Контрагенты.Ссылка В (&УжеОбработанные)";

    Запрос.УстановитьПараметр("ДатаПоследнегоОбмена", ДатаПоследнегоОбмена);
    Запрос.УстановитьПараметр("УжеОбработанные", ОбработанныеСсылки);

    Результат = Запрос.Выполнить();
    Если Результат.Пустой() Тогда
        Прервать;
    КонецЕсли;

    // Обработка пакета
    ОбработатьПакет(Результат);

КонецЦикла;
```

### Кэширование справочников

```bsl
// Кэширование для ускорения поиска
Перем КэшНоменклатуры;

Функция НайтиНоменклатуруПоАртикулу(Артикул)

    Если КэшНоменклатуры = Неопределено Тогда
        КэшНоменклатуры = Новый Соответствие;
    КонецЕсли;

    Номенклатура = КэшНоменклатуры.Получить(Артикул);

    Если Номенклатура = Неопределено Тогда
        Номенклатура = Справочники.Номенклатура.НайтиПоРеквизиту(
            "Артикул", Артикул);
        КэшНоменклатуры.Вставить(Артикул, Номенклатура);
    КонецЕсли;

    Возврат Номенклатура;

КонецФункции
```

## Логирование

### Структура логов

```bsl
// Регистр сведений: ЖурналОбменаКД3

Измерения:
  - ИдентификаторСессии (УникальныйИдентификатор)
  - ДатаВремя (Дата)

Ресурсы:
  - Операция (Строка) // Выгрузка/Загрузка
  - ТипОбъекта (Строка)
  - Статус (Перечисление) // Успех/Ошибка/Предупреждение
  - Сообщение (Строка)
  - КоличествоОбъектов (Число)
  - ВремяВыполнения (Число) // мс
```

### Пример логирования

```bsl
Процедура ЗаписатьВЖурнал(Операция, ТипОбъекта, Статус, Сообщение,
    КоличествоОбъектов = 0, ВремяВыполнения = 0)

    НаборЗаписей = РегистрыСведений.ЖурналОбменаКД3.СоздатьНаборЗаписей();

    НоваяЗапись = НаборЗаписей.Добавить();
    НоваяЗапись.ИдентификаторСессии = ИдентификаторТекущейСессии;
    НоваяЗапись.ДатаВремя = ТекущаяДатаСеанса();
    НоваяЗапись.Операция = Операция;
    НоваяЗапись.ТипОбъекта = ТипОбъекта;
    НоваяЗапись.Статус = Статус;
    НоваяЗапись.Сообщение = Лев(Сообщение, 1000);
    НоваяЗапись.КоличествоОбъектов = КоличествоОбъектов;
    НоваяЗапись.ВремяВыполнения = ВремяВыполнения;

    НаборЗаписей.Записать(Ложь);

КонецПроцедуры
```

## Checklist

### Разработка

- [ ] Структура источника изучена
- [ ] Структура приёмника изучена
- [ ] Маппинг полей определён
- [ ] Алгоритмы преобразования разработаны
- [ ] Обработка ошибок реализована
- [ ] Логирование настроено

### Тестирование

- [ ] Тесты на тестовых базах выполнены
- [ ] Корректность данных проверена
- [ ] Обработка ошибок протестирована
- [ ] Нагрузочное тестирование проведено
- [ ] Откат изменений протестирован

### Code Review

- [ ] Именование соответствует стандарту
- [ ] Код оптимизирован
- [ ] Комментарии добавлены
- [ ] Документация обновлена

### Релиз

- [ ] Backup баз выполнен
- [ ] Развёртывание в production
- [ ] Мониторинг первых обменов
- [ ] Инструкция для поддержки
