# 1С:Предприятие 8.3 Patterns & Standards

## Версии платформы

| Версия | Назначение | Особенности |
|--------|-----------|-------------|
| **8.3.20** | Legacy системы | Стабильная, ограниченная поддержка новых возможностей |
| **8.3.24** | Новые разработки | JWT, S3, КриптоПро, улучшенный JSON |

### Матрица совместимости

| Функция | 8.3.20 | 8.3.24 |
|---------|--------|--------|
| ЗащищенноеСоединениеКриптоПро | ❌ | ✅ |
| JWT (JSON Web Token) | ❌ | ✅ |
| Хранилище S3 | ❌ | ✅ |
| Расширенный JSON | ⚠️ | ✅ |
| Асинхронные вызовы | ❌ | ⚠️ |

## Структура проекта

```
project/
├── src/
│   ├── Configuration/           # Конфигурация
│   │   ├── CommonModules/       # Общие модули
│   │   ├── Documents/           # Документы
│   │   ├── Catalogs/            # Справочники
│   │   ├── InformationRegisters/ # Регистры сведений
│   │   ├── AccumulationRegisters/ # Регистры накопления
│   │   ├── Reports/             # Отчёты
│   │   ├── DataProcessors/      # Обработки
│   │   ├── HTTPServices/        # HTTP-сервисы
│   │   └── ScheduledJobs/       # Регламентные задания
│   └── Extensions/              # Расширения
├── tests/
│   ├── unit/                    # xUnitFor1C тесты
│   └── features/                # Vanessa Automation сценарии
├── docs/
│   ├── architecture.md
│   └── api/
├── .bsl-language-server.json    # Настройки BSL LS
├── .editorconfig
└── .pre-commit-config.yaml
```

## Стандарты именования

### Объекты метаданных

```
Новые объекты: ал_ИмяОбъекта
Синоним: Имя Объекта (БЕЗ префикса!)
Устаревшие: Obsolete_ИмяОбъекта
```

**Примеры:**
- Справочник: `ал_ВидыДоговоров` → Синоним: "Виды договоров"
- Документ: `ал_ЗаявкаНаЛизинг` → Синоним: "Заявка на лизинг"
- Регистр: `ал_ГрафикПлатежей` → Синоним: "График платежей"

### Переменные и параметры

```bsl
// Локальные переменные: ИмяПеременной (CamelCase)
Перем СуммаДоговора;
Перем ДатаНачала;

// Параметры процедур: ИмяПараметра
Процедура РассчитатьГрафик(Договор, ПараметрыРасчета)

// Константы: ВЕРХНИЙ_РЕГИСТР (редко используется в 1С)
```

### Модули

```bsl
// Общие модули
ал_ОбщегоНазначения           // Общие функции
ал_ОбщегоНазначенияКлиент     // Клиентские функции
ал_ОбщегоНазначенияСервер     // Серверные функции
ал_РаботаСДоговорами          // Предметная область
ал_ИнтеграцияRabbitMQ         // Интеграции
```

## jdocstring Стандарт

### Полный формат

```bsl
/// @description Рассчитывает график платежей по договору лизинга.
///              Учитывает процентную ставку, срок и сумму договора.
/// @param {Справочник.ДоговорыЛизинга} Договор - Договор лизинга для расчёта
/// @param {Структура} ПараметрыРасчета - Параметры расчёта:
///   * Срок - Число - Срок в месяцах
///   * Ставка - Число - Процентная ставка годовая
///   * ДатаНачала - Дата - Дата начала графика
/// @returns {ТаблицаЗначений} Таблица с колонками:
///   * Период - Дата
///   * СуммаПлатежа - Число
///   * ОсновнойДолг - Число
///   * Проценты - Число
/// @throws {ИсключениеДоговорНеНайден} Если договор не существует
/// @throws {ИсключениеНекорректныеПараметры} Если параметры невалидны
/// @example
///   Параметры = Новый Структура;
///   Параметры.Вставить("Срок", 24);
///   Параметры.Вставить("Ставка", 15.5);
///   Параметры.Вставить("ДатаНачала", ТекущаяДата());
///
///   График = ал_РасчётГрафика.РассчитатьГрафик(МойДоговор, Параметры);
///   Для Каждого Строка Из График Цикл
///       Сообщить(Строка.Период + ": " + Строка.СуммаПлатежа);
///   КонецЦикла;
/// @since 8.3.24
/// @author Иванов А.С.
/// @task УЗ-12345
/// @tested да
/// @coverage 95%
Функция РассчитатьГрафик(Договор, ПараметрыРасчета) Экспорт
```

### Минимальный формат

```bsl
/// @description Возвращает текущий курс валюты
/// @param {Справочник.Валюты} Валюта - Валюта
/// @returns {Число} Курс валюты
/// @task УЗ-12345
Функция ПолучитьКурсВалюты(Валюта) Экспорт
```

### Теги jdocstring

| Тег | Обязательный | Описание |
|-----|--------------|----------|
| `@description` | ✅ | Описание функции |
| `@param` | ✅ | Параметры {Тип} Имя - Описание |
| `@returns` | ✅ | Возвращаемое значение |
| `@task` | ✅ | Номер задачи УЗ/Jira |
| `@throws` | ⚠️ | Исключения (если есть) |
| `@example` | ⚠️ | Пример использования |
| `@since` | ⚠️ | Версия платформы |
| `@author` | ⚠️ | Автор |
| `@tested` | ⚠️ | Статус тестирования |
| `@coverage` | ⚠️ | Покрытие тестами |

## Комментарии к изменениям

### Формат комментария

```bsl
// + Альфа-Лизинг. Иванов А.С. 29.11.2025. УЗ №12345.
// Описание внесённых изменений
НовыйКод();
// - Альфа-Лизинг. Иванов А.С. 29.11.2025.
```

### Примеры

```bsl
// Добавление нового кода
// + Альфа-Лизинг. Петров И.В. 15.12.2025. УЗ №54321.
// Добавлена проверка на нулевую ставку
Если СтавкаНДС = 0 Тогда
    Возврат 0;
КонецЕсли;
// - Альфа-Лизинг. Петров И.В. 15.12.2025.

// Изменение существующего кода
// + Альфа-Лизинг. Сидоров М.А. 20.12.2025. УЗ №67890.
// Изменён алгоритм расчёта комиссии
// Было: Комиссия = Сумма * 0.01;
Комиссия = Сумма * ал_НастройкиСистемы.ПолучитьСтавкуКомиссии();
// - Альфа-Лизинг. Сидоров М.А. 20.12.2025.
```

## SOLID для 1С

### S - Single Responsibility

```bsl
// ❌ ПЛОХО: Модуль делает всё
Модуль ал_РаботаСДоговорами
    Функция СоздатьДоговор()     // Создание
    Функция РассчитатьГрафик()   // Расчёт
    Функция ОтправитьEmail()     // Уведомления
    Функция СформироватьОтчёт()  // Отчётность
КонецМодуля

// ✅ ХОРОШО: Разделение ответственности
Модуль ал_СозданиеДоговоров      // Только создание
Модуль ал_РасчётГрафиков         // Только расчёты
Модуль ал_УведомленияПочта       // Только email
Модуль ал_ОтчётыДоговоры         // Только отчёты
```

### O - Open/Closed

```bsl
// ❌ ПЛОХО: Изменение кода при добавлении типа
Функция РассчитатьСкидку(ТипКлиента, Сумма)
    Если ТипКлиента = "VIP" Тогда
        Возврат Сумма * 0.1;
    ИначеЕсли ТипКлиента = "Обычный" Тогда
        Возврат Сумма * 0.05;
    // При добавлении нового типа нужно менять код
    КонецЕсли;
КонецФункции

// ✅ ХОРОШО: Расширение через данные
Функция РассчитатьСкидку(ТипКлиента, Сумма)
    СтавкаСкидки = ал_НастройкиСкидок.ПолучитьСтавку(ТипКлиента);
    Возврат Сумма * СтавкаСкидки;
КонецФункции
```

### L - Liskov Substitution

```bsl
// В 1С нет классического наследования, но принцип применим к интерфейсам

// ❌ ПЛОХО: Разное поведение для "наследников"
Функция ОбработатьДокумент(Документ)
    Если ТипЗнч(Документ) = Тип("Документ.ЗаказКлиента") Тогда
        // Специфичная логика
    ИначеЕсли ТипЗнч(Документ) = Тип("Документ.СчётНаОплату") Тогда
        // Другая специфичная логика
    КонецЕсли;
КонецФункции

// ✅ ХОРОШО: Единый интерфейс через модули менеджеров
Функция ОбработатьДокумент(Документ)
    МодульМенеджера = Документ.Метаданные().ПолноеИмя();
    Выполнить(МодульМенеджера + ".ОбработатьДокумент(Документ)");
КонецФункции
```

### I - Interface Segregation

```bsl
// ❌ ПЛОХО: Один большой "интерфейс"
// Общий модуль ал_РаботаСКонтрагентами
//   - СоздатьКонтрагента()
//   - ОбновитьКонтрагента()
//   - УдалитьКонтрагента()
//   - ПолучитьЗадолженность()
//   - ОтправитьУведомление()
//   - СформироватьАкт()

// ✅ ХОРОШО: Разделённые модули
// ал_КонтрагентыCRUD        - CRUD операции
// ал_КонтрагентыФинансы     - Финансовые операции
// ал_КонтрагентыУведомления - Уведомления
// ал_КонтрагентыДокументы   - Документооборот
```

### D - Dependency Inversion

```bsl
// ❌ ПЛОХО: Жёсткая зависимость
Функция ОтправитьУведомление(Контрагент, Текст)
    // Жёстко привязан к конкретной реализации
    СMTPСоединение = Новый ИнтернетПочта;
    СMTPСоединение.Подключиться("smtp.company.ru", ...);
    СMTPСоединение.Послать(...);
КонецФункции

// ✅ ХОРОШО: Абстракция через настройки
Функция ОтправитьУведомление(Контрагент, Текст)
    // Способ отправки определяется настройками
    СпособОтправки = ал_НастройкиУведомлений.ПолучитьСпособОтправки();

    Если СпособОтправки = "Email" Тогда
        ал_ОтправкаEmail.Отправить(Контрагент.Email, Текст);
    ИначеЕсли СпособОтправки = "SMS" Тогда
        ал_ОтправкаSMS.Отправить(Контрагент.Телефон, Текст);
    ИначеЕсли СпособОтправки = "Telegram" Тогда
        ал_ОтправкаTelegram.Отправить(Контрагент.TelegramID, Текст);
    КонецЕсли;
КонецФункции
```

## Паттерны проектирования

### Фабрика

```bsl
/// @description Создаёт обработчик документа по типу
/// @param {Тип} ТипДокумента - Тип документа
/// @returns {Структура} Обработчик с методами
Функция СоздатьОбработчикДокумента(ТипДокумента) Экспорт

    Обработчик = Новый Структура;

    Если ТипДокумента = Тип("Документ.ЗаказКлиента") Тогда
        Обработчик.Вставить("МодульОбработки", "ал_ОбработкаЗаказов");
        Обработчик.Вставить("МетодПроведения", "ПровестиЗаказ");
        Обработчик.Вставить("МетодОтмены", "ОтменитьПроведение");
    ИначеЕсли ТипДокумента = Тип("Документ.СчётНаОплату") Тогда
        Обработчик.Вставить("МодульОбработки", "ал_ОбработкаСчетов");
        Обработчик.Вставить("МетодПроведения", "ПровестиСчёт");
        Обработчик.Вставить("МетодОтмены", "ОтменитьПроведение");
    КонецЕсли;

    Возврат Обработчик;

КонецФункции
```

### Строитель (Builder)

```bsl
/// @description Строитель запроса
Функция НовыйПостроительЗапроса() Экспорт

    Построитель = Новый Структура;
    Построитель.Вставить("Таблицы", Новый Массив);
    Построитель.Вставить("Поля", Новый Массив);
    Построитель.Вставить("Условия", Новый Массив);
    Построитель.Вставить("Параметры", Новый Структура);

    Возврат Построитель;

КонецФункции

Функция ДобавитьТаблицу(Построитель, ИмяТаблицы) Экспорт
    Построитель.Таблицы.Добавить(ИмяТаблицы);
    Возврат Построитель;
КонецФункции

Функция ДобавитьПоле(Построитель, ИмяПоля, Псевдоним = "") Экспорт
    Поле = Новый Структура("Имя, Псевдоним", ИмяПоля, Псевдоним);
    Построитель.Поля.Добавить(Поле);
    Возврат Построитель;
КонецФункции

Функция ДобавитьУсловие(Построитель, Условие) Экспорт
    Построитель.Условия.Добавить(Условие);
    Возврат Построитель;
КонецФункции

Функция Построить(Построитель) Экспорт
    // Генерация текста запроса
    ТекстЗапроса = "ВЫБРАТЬ " + СтрСоединить(Построитель.Поля, ", ");
    ТекстЗапроса = ТекстЗапроса + " ИЗ " + СтрСоединить(Построитель.Таблицы, ", ");

    Если Построитель.Условия.Количество() > 0 Тогда
        ТекстЗапроса = ТекстЗапроса + " ГДЕ " + СтрСоединить(Построитель.Условия, " И ");
    КонецЕсли;

    Возврат ТекстЗапроса;
КонецФункции

// Использование:
// Запрос = НовыйПостроительЗапроса();
// ДобавитьТаблицу(Запрос, "Справочник.Контрагенты");
// ДобавитьПоле(Запрос, "Наименование");
// ДобавитьУсловие(Запрос, "НЕ ПометкаУдаления");
// ТекстЗапроса = Построить(Запрос);
```

### Стратегия

```bsl
/// @description Расчёт скидки по стратегии
/// @param {Строка} СтратегияРасчёта - Название стратегии
/// @param {Число} Сумма - Сумма для расчёта
/// @returns {Число} Размер скидки
Функция РассчитатьСкидку(СтратегияРасчёта, Сумма) Экспорт

    Если СтратегияРасчёта = "Процент" Тогда
        Возврат РассчитатьСкидкуПроцентом(Сумма);
    ИначеЕсли СтратегияРасчёта = "ФиксированнаяСумма" Тогда
        Возврат РассчитатьФиксированнуюСкидку(Сумма);
    ИначеЕсли СтратегияРасчёта = "Прогрессивная" Тогда
        Возврат РассчитатьПрогрессивнуюСкидку(Сумма);
    Иначе
        ВызватьИсключение "Неизвестная стратегия: " + СтратегияРасчёта;
    КонецЕсли;

КонецФункции
```

## Обработка ошибок

### Паттерн Try-Catch

```bsl
/// @description Безопасное выполнение операции
/// @param {Справочник.Контрагенты} Контрагент
/// @returns {Структура} Результат: Успех, Данные, ОписаниеОшибки
Функция БезопасноПолучитьДанныеКонтрагента(Контрагент) Экспорт

    Результат = Новый Структура;
    Результат.Вставить("Успех", Ложь);
    Результат.Вставить("Данные", Неопределено);
    Результат.Вставить("ОписаниеОшибки", "");

    Попытка

        Если НЕ ЗначениеЗаполнено(Контрагент) Тогда
            ВызватьИсключение "Контрагент не указан";
        КонецЕсли;

        Данные = ПолучитьДанныеКонтрагента(Контрагент);

        Результат.Успех = Истина;
        Результат.Данные = Данные;

    Исключение

        Результат.ОписаниеОшибки = ОписаниеОшибки();

        // Логирование
        ал_Логирование.ЗаписатьОшибку(
            "БезопасноПолучитьДанныеКонтрагента",
            ОписаниеОшибки(),
            Контрагент
        );

    КонецПопытки;

    Возврат Результат;

КонецФункции
```

### Валидация входных данных

```bsl
/// @description Валидирует параметры расчёта
/// @param {Структура} Параметры - Параметры для валидации
/// @throws {Исключение} При невалидных параметрах
Процедура ВалидироватьПараметрыРасчёта(Параметры) Экспорт

    Ошибки = Новый Массив;

    // Проверка обязательных полей
    Если НЕ Параметры.Свойство("Сумма") Тогда
        Ошибки.Добавить("Не указана сумма");
    ИначеЕсли Параметры.Сумма <= 0 Тогда
        Ошибки.Добавить("Сумма должна быть положительной");
    КонецЕсли;

    Если НЕ Параметры.Свойство("Срок") Тогда
        Ошибки.Добавить("Не указан срок");
    ИначеЕсли Параметры.Срок < 1 ИЛИ Параметры.Срок > 120 Тогда
        Ошибки.Добавить("Срок должен быть от 1 до 120 месяцев");
    КонецЕсли;

    Если НЕ Параметры.Свойство("Ставка") Тогда
        Ошибки.Добавить("Не указана ставка");
    ИначеЕсли Параметры.Ставка < 0 ИЛИ Параметры.Ставка > 100 Тогда
        Ошибки.Добавить("Ставка должна быть от 0 до 100%");
    КонецЕсли;

    Если Ошибки.Количество() > 0 Тогда
        ВызватьИсключение "Ошибки валидации: " + СтрСоединить(Ошибки, "; ");
    КонецЕсли;

КонецПроцедуры
```

## Оптимизация запросов

### Индексы

```bsl
// ❌ ПЛОХО: Запрос без использования индекса
ВЫБРАТЬ * ИЗ Документ.Заказы ГДЕ Комментарий ПОДОБНО "%важно%"

// ✅ ХОРОШО: Запрос по индексированному полю
ВЫБРАТЬ * ИЗ Документ.Заказы ГДЕ Контрагент = &Контрагент И Дата >= &ДатаНачала
```

### Пакетные операции

```bsl
// ❌ ПЛОХО: Много отдельных запросов
Для Каждого Контрагент Из СписокКонтрагентов Цикл
    Запрос = Новый Запрос("ВЫБРАТЬ * ИЗ Документ.Заказы ГДЕ Контрагент = &К");
    Запрос.УстановитьПараметр("К", Контрагент);
    Результат = Запрос.Выполнить();
КонецЦикла;

// ✅ ХОРОШО: Один запрос с параметром-списком
Запрос = Новый Запрос;
Запрос.Текст = "
    |ВЫБРАТЬ *
    |ИЗ Документ.Заказы
    |ГДЕ Контрагент В (&СписокКонтрагентов)";
Запрос.УстановитьПараметр("СписокКонтрагентов", СписокКонтрагентов);
Результат = Запрос.Выполнить();
```

### Временные таблицы

```bsl
// ✅ ХОРОШО: Использование временных таблиц для сложных запросов
Запрос = Новый Запрос;
Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
Запрос.Текст = "
    |ВЫБРАТЬ
    |   Контрагент,
    |   СУММА(Сумма) КАК Оборот
    |ПОМЕСТИТЬ ВТ_Обороты
    |ИЗ Документ.Заказы
    |ГДЕ Период МЕЖДУ &Начало И &Конец
    |СГРУППИРОВАТЬ ПО Контрагент
    |;
    |ВЫБРАТЬ
    |   К.Наименование,
    |   ЕСТЬNULL(О.Оборот, 0) КАК Оборот
    |ИЗ Справочник.Контрагенты КАК К
    |ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Обороты КАК О
    |   ПО К.Ссылка = О.Контрагент";
```

## Тестирование

### Unit-тесты (xUnitFor1C)

```bsl
// Файл: tests/unit/Тест_РасчётГрафика.bsl

Процедура Тест_РассчитатьГрафик_КорректныеПараметры() Экспорт

    // Arrange
    Параметры = Новый Структура;
    Параметры.Вставить("Сумма", 1000000);
    Параметры.Вставить("Срок", 12);
    Параметры.Вставить("Ставка", 15);

    // Act
    График = ал_РасчётГрафика.РассчитатьГрафик(Параметры);

    // Assert
    юТест.ПроверитьРавенство(График.Количество(), 12,
        "График должен содержать 12 строк");

    СуммаПлатежей = 0;
    Для Каждого Строка Из График Цикл
        СуммаПлатежей = СуммаПлатежей + Строка.СуммаПлатежа;
    КонецЦикла;

    юТест.ПроверитьИстину(СуммаПлатежей > 1000000,
        "Сумма платежей должна быть больше тела кредита");

КонецПроцедуры

Процедура Тест_РассчитатьГрафик_НулевойСрок_ВызываетИсключение() Экспорт

    // Arrange
    Параметры = Новый Структура;
    Параметры.Вставить("Сумма", 1000000);
    Параметры.Вставить("Срок", 0);  // Невалидный срок
    Параметры.Вставить("Ставка", 15);

    // Act & Assert
    Попытка
        ал_РасчётГрафика.РассчитатьГрафик(Параметры);
        юТест.ПрерватьТест("Должно было возникнуть исключение");
    Исключение
        юТест.ПроверитьВхождение(ОписаниеОшибки(), "Срок должен быть");
    КонецПопытки;

КонецПроцедуры
```

### Сценарные тесты (Vanessa Automation)

```gherkin
# language: ru
# encoding: utf-8

@Договоры @Расчёты
Функционал: Расчёт графика платежей
  Как финансовый менеджер
  Я хочу рассчитывать график платежей
  Чтобы показать клиенту условия договора

  Предыстория:
    Допустим Я открыл новую сессию 1С
    И Я авторизовался как "Менеджер"

  @smoke @critical
  Сценарий: Расчёт стандартного графика
    Дано Я открыл документ "ДоговорЛизинга" с номером "001"
    Когда Я нажимаю кнопку "Рассчитать график"
    Тогда Табличная часть "ГрафикПлатежей" содержит 24 строки
    И Сумма колонки "СуммаПлатежа" больше "1000000"

  @negative
  Сценарий: Расчёт без заполненной суммы
    Дано Я создаю новый документ "ДоговорЛизинга"
    Когда Я нажимаю кнопку "Рассчитать график"
    Тогда Я вижу сообщение об ошибке "Не заполнена сумма договора"
```

## Checklist

- [ ] jdocstring для всех экспортных методов
- [ ] Комментарии к изменениям (`// + ... // -`)
- [ ] Именование по стандарту (`ал_` префикс)
- [ ] SOLID принципы соблюдены
- [ ] Длина методов ≤ 200 строк
- [ ] Длина строки ≤ 120 символов
- [ ] Unit-тесты написаны (coverage ≥ 70%)
- [ ] Запросы оптимизированы
- [ ] Обработка ошибок реализована
- [ ] BSL Language Server проверка пройдена
