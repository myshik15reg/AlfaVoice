# Workflow: Возобновление работы по протоколу (protocol-resume)

## Описание
Этот рабочий процесс восстанавливает контекст прерванной работы по протоколу, анализирует состояние проекта и подготавливает к выполнению следующего шага.

## Параметры
- `protocol_number`: Номер протокола для возобновления

---

## Шаг 1: Локализация рабочей среды

**Цель:** Найти и перейти в рабочую среду протокола.

**Действия:**
1. Определить полное имя протокола по номеру, прочитав содержимое папки `../worktrees/`
2. Перейти в папку worktree: `cd ../worktrees/{protocol_number}-{task_name}`
3. Запомнить путь — это новый рабочий корень (CWD)

**Проверка:** CWD установлен в папку worktree протокола

---

## Шаг 2: Чтение официального статуса

**Цель:** Определить текущий шаг протокола по файлу состояния.

**Действия:**
1. Открыть файл `.protocols/{protocol_number}-{task_name}/context.md`
2. Внимательно изучить содержимое
3. Запомнить номер текущего шага (`Current Step`)

**Результат:** Номер текущего шага (например, `3`)

---

## Шаг 3: Проверка зафиксированного статуса

**Цель:** Определить, какой шаг был закоммичен последним.

**Действия:**
1. Выполнить команду: `git log -1 --pretty=format:"%s"`
2. Определить номер последнего закоммиченного шага из тега `[protocol-{protocol_number}/XX]`

**Результат:** Номер последнего закоммиченного шага

---

## Шаг 4: Проверка текущего состояния

**Цель:** Определить, есть ли незакоммиченные изменения.

**Действия:**
1. Выполнить команду: `git status --porcelain`
2. Определить наличие незакоммиченных изменений

**Результат:** Состояние рабочей директории (чистая или с изменениями)

---

## Шаг 5: Анализ состояния и принятие решения

**Цель:** Сравнить собранные данные и определить сценарий продолжения.

### Сценарий A: Чистое состояние (самый частый)

**Условие:**
- `git status` пуст
- Номер последнего коммита соответствует `(Current Step - 1)`

**Диагноз:** Работа была чисто прервана между шагами.

**Действия:**
1. Сообщить пользователю: "Контекст восстановлен. Работа прервана между шагами."
2. Перейти к Шагу 7 (Подготовка к работе)

### Сценарий B: Прерывание в середине шага

**Условие:**
- `git status` показывает незакоммиченные изменения

**Диагноз:** Работа была прервана во время выполнения текущего шага.

**Действия:**
1. Сообщить пользователю: "Обнаружены незавершенные изменения для шага {Current Step}."
2. Сообщить: "Проверяю изменения и продолжаю работу."
3. Внимательно изучить измененные файлы
4. Проанализировать, что уже сделано, а что не доделано
5. Перейти к Шагу 7 (Подготовка к работе)

### Сценарий C: Сбой после коммита, до обновления протокола

**Условие:**
- `git status` пуст
- Номер последнего коммита равен `Current Step`

**Диагноз:** Шаг был выполнен и закоммичен, но файлы протокола не успели обновиться.

**Действия:**
1. Сообщить пользователю: "Обнаружена рассинхронизация. Шаг {Current Step} уже закоммичен, но протокол не обновлен. Выполняю коррекцию."
2. Выполнить пост-шаговые действия:
   - Открыть файл `.protocols/{protocol_number}-{task_name}/log.md`
   - Добавить запись для завершенного шага, взяв информацию из сообщения последнего коммита (`git log -1`)
   - Полностью перезаписать `context.md`:
     - Увеличить `Current Step` на 1
     - Обновить `Status`
     - Обновить `Last Action Summary`
     - Обновить `Next Action` для следующего шага
3. Перейти к Шагу 7 (Подготовка к работе)

---

## Шаг 6: Добавление отметки о восстановлении контекста

**Цель:** Зафиксировать факт восстановления контекста в логе.

**Действия:**
1. Открыть файл `.protocols/{protocol_number}-{task_name}/log.md`
2. Посчитать, сколько раз в логе уже встречается запись "Restore context"
3. Добавить в начало файла после заголовка новую запись:
   ```
   Restore context: protocol-{protocol_number}#ctx-{новый_номер}
   ```
   (Например, если записей не было, будет `ctx-2`)

**Проверка:** Запись добавлена в `log.md`

---

## Шаг 7: Подготовка к работе

**Цель:** Прочитать инструкции следующего шага и проверить окружение.

**Действия:**
1. Открыть обновленный `context.md`
2. Посмотреть на `Current Step` и `Next Action`
3. Открыть соответствующий файл шага (например, `.protocols/{protocol_number}-{task_name}/03-implement-feature.md`)
4. Внимательно изучить содержимое файла шага
5. Убедиться, что CWD — это worktree с нужной папкой `{protocol_number}-{task_name}`
6. Убедиться, что находишься в нужной ветке Git

**Проверка:** Окружение настроено, инструкции следующего шага изучены

---

## Шаг 8: Финальный отчет

**Цель:** Представить пользователю отчет о готовности к продолжению работы.

### Формат отчета для Сценария A (Чистое состояние)

```
Контекст восстановлен для протокола {protocol_number}-{task_name}.

Рабочая папка (CWD): {абсолютный путь к worktree}
Состояние ветки main: {сведения о ветке main, верификация что файлы из worktree не попали в main}
Текущее состояние: Готов приступить к шагу {Current Step}
Моя следующая задача: {Краткое описание следующего действия по шагу}
```

### Формат отчета для Сценария B (Прерывание в середине шага)

```
Контекст восстановлен для протокола {protocol_number}-{task_name}.
Я обнаружил незавершенные изменения для шага {Current Step}, внимательно изучил их, и готов продолжить с места прерывания работы.

Рабочая папка (CWD): {абсолютный путь к worktree}
Состояние ветки main: {сведения о ветке main, верификация что файлы из worktree не попали в main}
Текущее состояние: Готов продолжить шаг {Current Step}
Моя следующая задача: {Краткое описание следующего действия по шагу}
```

### Формат отчета для Сценария C (Сбой после коммита)

```
Контекст восстановлен для протокола {protocol_number}-{task_name}.
Обнаружена рассинхронизация: шаг {Current Step} уже закоммичен, но протокол не был обновлен. Выполнил коррекцию протокола.

Рабочая папка (CWD): {абсолютный путь к worktree}
Состояние ветки main: {сведения о ветке main, верификация что файлы из worktree не попали в main}
Текущее состояние: Готов приступить к шагу {Current Step}
Моя следующая задача: {Краткое описание следующего действия по шагу}
```

---

## Завершение

После представления отчета работа начинается после подтверждения пользователя, что можно продолжать.
