# Workflow: Ревью и слияние протокола (protocol-review-merge)

## Описание
Этот рабочий процесс проводит исчерпывающее ревью работы, выполненной по протоколу, предоставляет отчет и, по команде пользователя, выполняет слияние (merge) с веткой main.

**Ключевые этапы:**
1. Сбор контекста и подготовка
2. Поиск Pull Request
3. Изучение плана и истории
4. Создание артефактов для ревью
5. Выполнение ревью (включая Deep Analysis)
6. Отчет о ревью
7. Слияние (по команде пользователя)
8. Финальный отчет

**Deep Analysis:** Включает глубокий анализ измененных компонентов с использованием `deep-analysis.md`, проверку архитектурных принципов из Memory Bank (`architecture.md`) и выявление потенциальных нарушений паттернов.

## Параметры
- `protocol_number`: Номер протокола для ревью и слияния

## Главный принцип
"Не доверяй, а проверяй"

---

## Шаг 1: Сбор контекста и подготовка

**Цель:** Определить рабочую среду и найти артефакты протокола.

**Действия:**
1. Убедиться, что рабочая папка (CWD) — корень основного проекта
2. Проверить, что находишься в ветке `main`: `git branch --show-current`
3. Проверить, что ветка чиста: `git status`
4. Определить имя протокола по номеру, прочитав содержимое папки `.protocols/`
5. Запомнить пути:
   - Путь к артефактам протокола: `.protocols/{protocol_number}-{task_name}/`
   - Путь к коду в worktree: `../worktrees/{protocol_number}-{task_name}/`
6. Не переходить (cd) в эти папки, работать через относительные пути из корня проекта

**Проверка:** CWD — корень проекта, ветка `main`, все пути определены

---

## Шаг 2: Поиск Pull Request

**Цель:** Найти связанный с протоколом Pull Request.

**Действия:**
1. Определить имя ветки: `{protocol_number}-{task_name}`
2. Найти связанный PR: `gh pr list --head "{имя_ветки}"`
3. Запомнить номер PR
4. Убедиться, что PR открыт (не в статусе Draft)

**Результат:** Номер PR и его статус

---

## Шаг 3: Изучение плана и истории

**Цель:** Изучить, что планировалось и что было сделано.

**Действия:**
1. Открыть и полностью изучить `plan.md` в папке артефактов протокола
2. Открыть и полностью изучить `log.md` в папке артефактов протокола
3. Открыть файлы `{XX-название_шага.md}` с детальными планами шагов

**Результат:** Понимание плана и истории выполнения

---

## Шаг 4: Создание артефактов для ревью

**Цель:** Создать файлы для отслеживания процесса ревью.

**Действия:**
1. В папке `.protocols/{protocol_number}-{task_name}/` создать два файла:
   - `review-plan.md`
   - `review-log.md` (изначально пустой)
2. Заполнить `review-plan.md` по шаблону (см. ниже)

**Проверка:** Файлы созданы, `review-plan.md` заполнен

### Шаблон review-plan.md

```markdown
# Review and Merge Plan for Protocol {protocol_number}

## Review/Merge Workflow (Инструкция по выполнению):

Папка проекта (project root): {абсолютный путь к папке протокола}
Папка worktree (worktree root): {абсолютный путь к папке ворктрее}
Папка протокола: {путь к папке протокола в ворктрее, можно абсолютный}

**Твоя задача — выполнять шаги из `Detailed Plan` ниже, строго следуя этому рабочему циклу.**

### A. Перед началом нового шага
1. **Проверка окружения:** Выполни и залогируй результат команд `pwd` (должен быть корень проекта) и `git branch --show-current`.
2. **Чтение инструкций:** Внимательно прочитай описание текущего шага в этом плане.
3. Сообщи пользователю, какой шаг ты начинаешь.

### B. Во время выполнения шага
1. Выполняй подзадачи. Используй пути `../worktrees/{protocol_number}-{...}/` для доступа к коду.
2. Следуй `Review/Merge Principles`.

### C. Сразу после завершения шага
1. **Добавь запись в `review-log.md`:** Детально опиши, что сделано, результаты проверок, ID коммита (если был).
2. **Закоммить изменения** в `review-log.md` и `review-plan.md` в ветку `main`.
3. **Повторная проверка окружения:** Снова выполни и залогируй `pwd` и `git branch --show-current`, чтобы убедиться, что ты остался в правильном контексте.
4. Отчитайся пользователю о завершении шага.

---

## Review/Merge Principles (MUST follow):

- **Методичность:** Строго следуй плану. Никаких пропусков шагов без команды пользователя.
- **Контроль окружения:** Постоянно проверяй свой CWD и текущую ветку Git.
- **Отчетность:** Все действия подробно фиксируй в `review-log.md`.

---

## Detailed Plan:

### Шаг 1-m. Проверка CI/CD
1. Выполни `gh pr checks {НОМЕР_PR}`.
2. Если есть проваленные проверки (`failure`), останови ревью и сообщи об этом как о блокирующей проблеме.

### Шаг 2-m. Локальная верификация
1. Работая из корня проекта, запусти все локальные проверки для кода в worktree:
   - `npm run lint --prefix ../worktrees/{protocol_number}-{...}/`
   - `npm run typecheck --prefix ../worktrees/{protocol_number}-{...}/`
   - `npm run build --prefix ../worktrees/{protocol_number}-{...}/`
   - `npm test --prefix ../worktrees/{protocol_number}-{...}/`
2. Если найдены проблемы, согласуй с пользователем их исправление.
3. Исправления делай в **ветке фичи**, создавая коммиты с тегом `[protocol-{protocol_number}/2-m-fix]`.

### Шаг 2.5-m. Deep Analysis (Глубокий анализ)
1. **Запуск глубокого анализа:** Выполни `deep-analysis.md` для измененных компонентов в worktree:
   - Определи список измененных файлов: `git diff --name-only origin/main...{protocol_number}-{task_name}`
   - Для каждого измененного компонента запусти процедуру глубокого анализа согласно `deep-analysis.md`
   - Сосредоточься на архитектурных аспектах, паттернах, связях между компонентами
2. **Проверка архитектурных принципов:** Сравни результаты анализа с архитектурными принципами из Memory Bank:
   - Проверь `.kilocode/rules/memory-bank/architecture.md` для актуальных архитектурных решений
   - Убедись, что новый код не нарушает установленные паттерны и принципы
   - Проверь соответствие стандартам кодирования и структурирования
3. **Документирование:** Добавь результаты глубокого анализа в `review-log.md`:
   - Выявленные архитектурные проблемы (если есть)
   - Нарушения паттернов или принципов (если есть)
   - Рекомендации по улучшению (если есть)
4. **Обсуждение:** Если обнаружены серьезные архитектурные проблемы:
   - Останови ревью и сообщи пользователю
   - Предложи варианты исправления
   - Жди явного подтверждения перед продолжением

### Шаг 3-m. Ревью кода
1. **Сверь план с фактом:** Сравни `plan.md` и `log.md` с фактическими изменениями в коде.
2. Выполни `git diff origin/main...{protocol_number}-{task_name}` и проанализируй все изменения.
3. Проверь соответствие реализации плану, стандартам кодирования и общим принципам.
4. Если есть замечания, обсуди их с пользователем.

### Шаг 4-m. Финальное слияние (Merge)
1. Работай из папки project root, проверь.
2. **Получи явное разрешение от пользователя на слияние.**
3. Выполни строгую последовательность команд из корня проекта:

   ```bash
   # 1. Убедись, что ты на main
   git checkout main

   # 2. Обнови main
   git pull origin main

   # 3. Выполни слияние без fast-forward
   git merge --no-ff {protocol_number}-{task_name}

   # 4. Отправь изменения на сервер
   git push origin main
   ```

4. Если возникнут конфликты:
   - Остановись и попроси согласования у пользователя
   - Ориентируйся на последние закрытые протоколы из папки `.protocols/`
   - После решения конфликтов выполни проверки качества: `typecheck`, `lint`, `build`, `test`
   - Все проверки должны проходить, все недоработки должны быть исправлены

### Шаг 5-m. Очистка
1. Работай из папки project root, проверь.
2. После успешного слияния:
   - Удали ветку на сервере: `git push origin --delete {protocol_number}-{task_name}`
   - Удали локальную ветку: `git branch -d {protocol_number}-{task_name}`
   - Удали worktree: `git worktree remove ../worktrees/{protocol_number}-{task_name}`
3. Сообщи пользователю о полном завершении работы.
```

---

## Шаг 5: Выполнение ревью (согласно review-plan.md)

**Цель:** Провести полное ревью работы по протоколу.

**Действия:**
1. Следовать рабочему циклу, описанному в `Review/Merge Workflow` внутри `review-plan.md` для каждого шага
2. Все действия, выводы и результаты проверок методично заносить в `review-log.md`
3. Изменения в `review-plan.md` и `review-log.md` коммитить в ветку `main` с сообщениями формата:
   ```
   chore(review): update review log for {protocol_number} [protocol-{protocol_number}/ZZ-m]
   ```
   где `ZZ` — шаг ревью

**Проверка:** Все шаги ревью выполнены, `review-log.md` заполнен

---

## Шаг 6: Отчет о ревью

**Цель:** Представить пользователю результаты ревью.

### Формат отчета

```
Ревью протокола {protocol_number}-{task_name} завершено.

**Pull Request:** #{НОМЕР_PR}
**Статус PR:** {Draft/Open/Merged}

**Проверки CI/CD:**
- {список проверок и их статусы}

**Локальная верификация:**
- typecheck: {прошел/не прошел}
- lint: {прошел/не прошел}
- build: {прошел/не прошел}
- test: {прошел/не прошел}

**Deep Analysis (Глубокий анализ):**
- Архитектурные проблемы: {список проблем или "нет проблем"}
- Нарушения паттернов: {список нарушений или "нет нарушений"}
- Соответствие architecture.md: {соответствует/не соответствует}
- Рекомендации: {список рекомендаций или "нет рекомендаций"}

**Ревью кода:**
- Соответствие плану: {соответствует/не соответствует}
- Замечания: {список замечаний или "нет замечаний"}

**Рекомендация:**
{Готов к слиянию / Требуются исправления / Не готов к слиянию}
```

---

## Шаг 7: Слияние (по команде пользователя)

**Цель:** Выполнить слияние ветки с main.

**Действия:**
1. Получить явное разрешение от пользователя на слияние
2. Выполнить Шаг 4-m из `review-plan.md` (Финальное слияние)
3. Выполнить Шаг 5-m из `review-plan.md` (Очистка)
4. Сообщить пользователю о полном завершении работы

**Проверка:** Ветка слита, worktree удален, протокол завершен

---

## Шаг 8: Финальный отчет

**Цель:** Представить пользователю финальный отчет о завершении.

### Формат финального отчета

```
Протокол {protocol_number}-{task_name} успешно завершен.

**Слияние:**
- Ветка слита с main
- PR #{НОМЕР_PR} закрыт
- Worktree удален

**Результаты:**
- Все проверки пройдены (CI/CD, локальная верификация)
- Deep Analysis завершен: архитектурные принципы соблюдены
- Код соответствует плану и стандартам
- Документация обновлена

**Архитектурная целостность:**
- Паттерны и принципы из architecture.md соблюдены
- Нарушений архитектуры не обнаружено
- Код интегрирован в соответствии с AlfaFlow стандартами

**Следующие шаги:**
{Рекомендации по дальнейшей работе}
```
