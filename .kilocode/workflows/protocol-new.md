# Workflow: Создание нового протокола (protocol-new)

## Описание
Этот рабочий процесс создаёт новый протокол для изолированной разработки задачи. Он создаёт рабочее пространство (worktree), генерирует план работы и открывает Pull Request.

## Параметры
- `task_name`: Краткое имя задачи (например, "add-auth")
- `task_description`: Подробное описание задачи
- `protocol_number`: (опционально) Номер протокола. Если не указан, определяется автоматически

---

## Шаг 1: Проверка окружения

**Цель:** Убедиться, что Git в чистом состоянии и готов к созданию новой ветки.

**Действия:**
1. Проверить текущую ветку: `git branch --show-current` (должна быть `main`)
2. Проверить статус Git: `git status` (рабочая директория должна быть чиста)
3. Если есть незафиксированные изменения — спросить пользователя, как поступить
4. Выполнить `git fetch origin` для обновления информации с сервера
5. Сверить состояние локального `main` с `origin/main`
6. Запустить проверки проекта (typecheck, lint). Если не проходят — предложить исправления

**Проверка:** Все проверки пройдены, ветка `main` чиста и актуальна

---

## Шаг 2: Определение номера протокола

**Цель:** Определить уникальный номер для нового протокола.

**Действия:**
1. Прочитать содержимое папки `../worktrees/` (если существует)
2. Прочитать содержимое папки `.protocols/`
3. Найти максимальный существующий номер протокола
4. Использовать следующий номер для нового протокола (формат: NNNN)

**Результат:** Номер протокола (например, `0105`)

---

## Шаг 3: Создание worktree

**Цель:** Создать изолированное рабочее пространство для протокола.

**Действия:**
1. Сформировать имя протокола: `{protocol_number}-{task_name}`
2. Выполнить команду:
   ```bash
   git worktree add --checkout -b {protocol_number}-{task_name} ../worktrees/{protocol_number}-{task_name} origin/main
   ```
3. Перейти в созданное worktree — это новый рабочий корень (CWD)
4. Запомнить абсолютные пути:
   - `PROJECT_ROOT`: корень основного проекта
   - `CWD`: папка worktree

**Проверка:** Worktree создан успешно, текущая директория — CWD

---

## Шаг 4: Создание структуры протокола

**Цель:** Создать файлы протокола с планом работы.

**Действия:**
1. Создать папку: `.protocols/{protocol_number}-{task_name}/`
2. Создать файлы:
   - `plan.md` — главный план
   - `context.md` — текущее состояние
   - `log.md` — журнал работы
   - `00-setup.md` — план первого шага
   - `XX-{step_name}.md` — файлы для каждого последующего шага

**Принципы планирования:**
- **Баланс и простота:** Избегать оверинжиниринга, использовать простые решения
- **Никакого легаси:** Удалять устаревший код, обратная совместимость не требуется
- **Стандарты кодирования:** Следовать JSDoc, форматированию и линтингу проекта
- **Memory Bank Bible:** Обновлять документацию по правилам MBB
- **Качественные тесты:** Сбалансированное покрытие, переиспользуемые хелперы
- **Детализация:** План должен быть самодостаточным, каждый шаг разбит на подзадачи

---

## Шаг 5: Заполнение файлов протокола

**Цель:** Заполнить файлы протокола начальным содержимым.

### Шаблон plan.md
```markdown
# {protocol_number} — {task_name}

## ADR-style Summary:
- **Context**: ...
- **Problem Statement**: ...
- **Decision**: ...
- **Alternatives**: ...
- **Consequences**: ...

---

## High-Level Plan:

Этот раздел является **контрактом**, не меняй его при реализации.

- **[Шаг 0: Подготовка и фиксация плана](./00-setup.md)**: Создание и фиксация артефактов протокола.
- **[Шаг 1: ...](./01-step-name.md)**: ...
- **[Шаг 2: ...](./02-step-name.md)**: ...
- ...
- **[Шаг (последний): Финализация](./XX-finalize.md)**:
  * Перевод PR в статус Ready
  * Завершение работы.

---

## Protocol Workflow (Инструкция по выполнению):

**Твоя задача — выполнять шаги из `High-Level Plan`, строго следуя этому рабочему циклу для каждого шага.**

- **Папка проекта (PROJECT_ROOT)**: {абсолютный путь к корню проекта}
- **Папка worktree (CWD)**: {абсолютный путь к папке worktree}
- **Папка протокола**: {абсолютный путь к папке .protocols/{protocol_number}-{task_name}}

**Вся работа ведется из папки worktree (CWD).**

### A. Перед началом нового шага (Восстановление контекста)
1. Определи текущий шаг, прочитав `Current Step` из файла `context.md` в папке протокола.
2. Открой и изучи файл этого шага (например, `01-step-name.md`).
3. Убедись, что все предыдущие изменения закоммичены.

### B. Во время выполнения шага (Исполнение)
1. Выполняй подзадачи, описанные в файле текущего шага.
2. Не изменяй файлы планов (`plan.md`, `XX-*.md`). Они являются контрактом.
3. Следуй общим принципам, изложенным ниже.

### C. Сразу после завершения шага (Верификация и Фиксация)
1. Выполни проверки: `typecheck`, `lint`, `test`. Исправляй проблемы, пока все проверки не пройдут.
2. Добавь запись в `log.md`: Опиши, что было сделано, и почему.
3. Полностью перезапиши `context.md` новым состоянием для следующего шага.
4. Проверь ветку main чтобы не было случайно добавленных наших файлов из нашей ветки.
5. Сделай коммит с сообщением по формату `type(scope): subject [protocol-{protocol_number}/YY]`. Сделай пуш.
6. Сообщи пользователю о завершении шага.

---

## Generic Principles (MUST follow):
- Баланс и простота
- Никакого легаси
- Стандарты кодирования
- Memory Bank Bible
- Качественные тесты
- Детализация

---

## Reference Materials
...
```

### Шаблон context.md (начальное)
```markdown
- **Current Step**: 0
- **Status**: Not Started
- **Last Action Summary**: "План сгенерирован и ожидает утверждения."
- **Next Action**: "Приступить к выполнению Шага 0 (см. `00-setup.md`)."
- **Git**: "Ветка {protocol_number}-{task_name} создана, но пока пуста."
- **PROJECT_ROOT**: "{абсолютный путь к корню проекта}"
- **CWD**: "{абсолютный путь к папке worktree}"
```

### Шаблон log.md (начальное)
```markdown
# Work Log: {protocol_number} — {task_name}

Этот раздел является **журналом**. Записи только добавляются, старые не изменяются:
```

### Шаблон 00-setup.md
```markdown
# Шаг 0: Подготовка и фиксация плана

## Briefing
Этот шаг — технический. Его цель — зафиксировать все созданные файлы плана в первом коммите, опубликовать ветку и создать Pull Request.

## Sub-tasks
1. Создать и сохранить все артефакты протокола в `.protocols/{protocol_number}-{task_name}/`.
2. Сделать первый коммит с этими файлами в ветку `{protocol_number}-{task_name}`.
3. Создать Draft Pull Request на GitHub.
4. Обновить `context.md`: изменить `Current Step` на `1`, `Status` на `In Progress`.
5. Сохранить измененный `context.md` без коммита (он войдет в коммит следующего шага).
```

### Шаблон файла шага (XX-{step_name}.md)
```markdown
# Шаг XX: {Название шага}

## Briefing
- **Цель:** {Краткое описание цели}
- **Ключевые файлы:**
  - `path/to/file1.ts` (создать/изменить)
  - `path/to/file2.ts` (прочитать)
- **Additional info:** {дополнительная информация}

## Sub-tasks
{Детальный пошаговый план действий}

## Workflow (Порядок работы)

**Твоя задача — выполнить `Sub-tasks` выше, строго следуя этому циклу.**

1. **Выполнение:** Последовательно выполняй подзадачи.
2. **Верификация:** После завершения ВСЕХ подзадач запусти проверки:
   - `npm run lint [путь/к/файлу]`
   - `npm run typecheck`
   - `npm test [путь/к/тесту]`
3. **Фиксация:** После успешной верификации:
   - Добавь запись в `log.md`
   - Обнови `context.md`
   - Проверь ветку main в поисках случайно добавленных файлов
4. **Сделай коммит:** `git add .` и `git commit -m "..."`. Сделай пуш.
5. **Отчет пользователю:** Сообщи о завершении шага.
```

---

## Шаг 6: Первый коммит

**Цель:** Зафиксировать артефакты протокола в Git.

**Действия:**
1. Добавить файлы протокола: `git add .protocols/{protocol_number}-{task_name}`
2. Сделать коммит:
   ```bash
   git commit -m "feat(protocol): add plan for {protocol_number}-{task_name} [protocol-{protocol_number}/00]"
   ```

**Проверка:** Коммит создан успешно

---

## Шаг 7: Создание Pull Request

**Цель:** Создать Draft PR для отслеживания работы.

**Действия:**
1. Запушить ветку:
   ```bash
   git push --set-upstream origin {protocol_number}-{task_name}
   ```
2. Создать Draft PR:
   ```bash
   gh pr create --draft --title "WIP: {protocol_number} - {task_name}" --body "This PR is being worked on according to protocol {protocol_number}. See the protocol directory for the detailed plan: .protocols/{protocol_number}-{task_name}/"
   ```
3. Сообщить пользователю URL созданного PR

---

## Шаг 8: Завершение подготовки

**Цель:** Обновить контекст протокола для начала работы.

**Действия:**
1. Обновить `context.md`:
   - `Current Step`: 1
   - `Status`: In Progress
   - `Last Action Summary`: "Шаг 0 завершен: рабочее пространство создано, план зафиксирован, PR открыт."
   - `Next Action`: "Приступить к выполнению Шага 1 (см. 01-{имя-шага}.md)."
2. Сохранить измененный `context.md` без создания коммита

---

## Шаг 9: Отчет пользователю

**Цель:** Представить результат подготовки.

**Действия:**
1. Сообщить о полном завершении подготовки
2. Вывести содержимое `plan.md` и `00-setup.md` для финального согласования
3. Если план дорабатывается — зафиксировать изменения через amend commit

---

## Формат отчета о шаге

```
(Протокол {protocol_number}, шаг XX):

**Сделано**: список сделанных изменений - что, где, для чего

**Проверки**: какие проверки запускались (lint, typecheck, test, ...), что прошло, что нет, и почему

**Git**:
- с каким PR работаем,
- какая текущая ветка,
- какой сделан коммит,
- проверка ветки main в поисках случайно добавленных файлов (что проверка пройдена. ветка чистая)

**Рабочая папка**: {абсолютный путь к worktree}

**Статус протокола**: какой статус выполнения, что сделано, где находимся, что будем делать дальше
```
